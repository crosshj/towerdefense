<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>DB Test</title>
		<meta
			name="viewport"
			content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"
		/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="full-screen" content="true" />
		<meta name="screen-orientation" content="portrait" />

		<script src="js/dragonBones.js"></script>
	</head>
	<style>
		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body,
		html {
			padding: 0;
			border: 0;
			margin: 0;
			height: 100%;
			background: #3c3c3c;
			box-sizing: border-box;
			-ms-touch-action: none;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			overflow: hidden;
			color: #fff;
			font-weight: 100;
			font: 80%/1.65 Verdana, 'Geneva CE', lucida, 'Microsoft YaHei',
				sans-serif;
		}

		body {
			display: flex;
			justify-content: center;
			align-items: center;
			flex-direction: column;
		}

		canvas {
			background: #555;
			image-rendering: pixelated;
			zoom: 2;
		}
	</style>
	<body>
		<canvas id="test-canvas" width="128" height="128"></canvas>
		<div style="margin-top: 1em">
			<select required id="model-choice" value="">
				<option value="" disabled selected hidden>
					Choose model...
				</option>
				<option value="-1" disabled>---</option>
				<option value="./base_fighter_tex.png">Big Head White</option>
				<option value="./base_fighter_tex_pink.png">
					Small Head Pink
				</option>
				<option value="fighterBaseIdle">Fighter Base Idle</option>
				<option value="fighterBaseJumping">Fighter Base Jumping</option>
				<option value="fighterBaseSwap1">Fighter Base Swap 1</option>
				<option value="fighterBaseSwap2">Fighter Base Swap 2</option>
			</select>
			<button id="model-switch" type="button">SWITCH</button>
		</div>
	</body>
	<script type="module">
		import { POJFactory, POJArmatureDisplay } from './test.js';

		const whichTexture =
			localStorage.getItem('spriteModelChoice') ||
			'./base_fighter_tex.png';

		let skeleton = './base_fighter_ske.json';
		let atlas = './base_fighter_tex.json';
		let texture = whichTexture;
		let anim = 'look_up';
		let animSpeed = 1000 / 40;

		if (whichTexture.startsWith('fighterBase')) {
			skeleton = './FighterBase/FighterBase_ske.json';
			atlas = './FighterBase/FighterBase_tex.json';
			texture = './FighterBase/FighterBase_tex.png';
			anim =
				whichTexture === 'fighterBaseSwap1'
					? 'sprite_swap'
					: 'sprite_swap2';
			if (whichTexture === 'fighterBaseJumping') {
				anim = 'jumping';
			}
			if (whichTexture === 'fighterBaseIdle') {
				anim = 'idle';
			}
			animSpeed = 1000 / 30;
		}

		document
			.getElementById('model-switch')
			.addEventListener('mousedown', () => {
				const modelChoice =
					document.getElementById('model-choice').value;
				localStorage.setItem('spriteModelChoice', modelChoice);
				document.location.reload();
			});

		const canvas = document.getElementById('test-canvas');
		const em = new POJArmatureDisplay(null);
		const dbInstance = new dragonBones.DragonBones(em);
		const factory = new POJFactory(dbInstance, canvas);

		await factory.loadData({ skeleton, atlas, texture });
		window.armature = factory.buildArmatureDisplay('Armature');

		armature.animation.play(anim);
		const switchAnim = () => {
			const newAnim = anim === 'run' ? 'look_up' : 'run';
			anim = newAnim;
			armature.animation.play(newAnim);
		};

		let count = 0;
		setInterval(() => {
			if (!anim.startsWith('sprite_swap')) {
				count++;
				if (count === 120) {
					count = 0;
					switchAnim();
				}
			}
			window.requestAnimationFrame(() => {
				factory.advanceTime(1 / 24);
			});
		}, animSpeed);
	</script>
</html>
